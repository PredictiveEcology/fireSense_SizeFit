---
title: "fireSense_SizeFit"
author: "Jean Marchal"
date: "July 2017"
output:
  html_document: default
  pdf_document: default
---

# Overview
Fit statistical models of the fire size distribution. A tapered Pareto distribution is assumed. This distribution has three parameters: $a$, $\beta$ and $\theta$; $a$ is the lower truncation point and is assumed to be known $a$ priori, $\beta$ controls the rate of frequency decrease as the fire size increases, and $\theta$ governs the location of the exponential taper. This module can be used to relate $\beta$ and $\theta$ with environmental controls of the fire size distribution.


# Download the module
```{r download module, eval = FALSE, echo = TRUE}
library(SpaDES)

moduleName <- "fireSense_SizeFit"

workingDirectory <- tempdir() # Location where the module will be downloaded

downloadModule(moduleName, path = workingDirectory)
```

# Usage
## Module parameters
Name|Default|Description
----|:--------------|---------------------------------------------------------------------
`formula`||a named list with two elements, "beta" and "theta", describing the model to be fitted. "beta" and "theta" should be formulas (see `?formula`).
`a`||lower truncation point $a$ of the tapered Pareto. The random variable $x$ take values on the interval $a <= x < Inf$. Values outside of this range are ignored with a warning.
`link`|`list(beta = "log",`<br>`theta = "identity")`|a named list with two elements, "beta" and "theta", specifying link functions for $\beta$ and $\theta$ parameters of the tapered Pareto. These can be character strings or objects of class link-glm. For more additional details see `?family`.
`start`|`NULL`|optional. Named list with two elements, "beta" and "theta", specifying starting values for the coefficients to be estimated. Those are passed to `nlminb` and can be a single vector, or a list of vectors. In the latter case, only the best solution, that is, the one which minimizes the most the objective function, is kept.
`lb`|`NULL`|optional named list with two elements called beta and theta specifying lower bounds for the coefficients to be optimized over. These must be finite and will be recycled if necessary to match `length(coefficients)`.
`ub`|`NULL`|optional named list with two elements called beta and theta specifying upper bounds for the coefficients to be optimized over. These must be finite and will be recycled if necessary to match `length(coefficients)`.
`nlminb.control`|`list(iter.max = 5e3L,`<br>`eval.max = 5e3L)`|optional list of control parameters to be passed to the `nlminb` optimizer. See `?nlminb`.
`trace`|`0`|non-negative `integer`. If > 0, tracing information on the progress of the optimization are printed every `trace` iteration. Default is 0, which turns off tracing.
`data`|`"dataFireSense_SizeFit"`|a character vector indicating the names of objects in the `simList` environment in which to look for variables in the model. `data` objects should be data.frames. If omitted, or if variables are not found in `data` objects, variables are searched in the `simList` environment.
`initialRunTime`|`start(simList)`|when to start this module? By default, the start time of the simulation.
`intervalRunModule`|`NA`|optional. Interval between two runs of this module, expressed in units of simulation time.
|||

## Usage example
```{r module usage example, eval = FALSE}
library(SpaDES)

# Packages required by the module
library(DEoptimR)
library(magrittr)
library(numDeriv)
library(PtProcess)

set.seed(1)

# Create random weather and fire size data
dataObject <- data.frame(
  weather = rnorm(1000, 150, 30),
  size_ha = rtappareto(1000, .3, 1e4, a = 1)
)

#outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 1, end = 1, timeunit = "year")
parameters <- list(
  fireSense_SizeFit = list(
    formula = list(beta = size_ha ~ weather,
                   theta = size_ha ~ weather),
    a = 1,
    data = "dataObject",
    trace = 5 # Print progress every 5 iterations
  )
)

modules <- list("fireSense_SizeFit")
objects <- "dataObject" # Pass objects found in the global environment to the simList environment
paths <- list(
  # cachePath = file.path(outputDir, "cache"),
  modulePath = file.path("~/Documents/GitHub/McIntire-lab/modulesPrivate/") ## TODO: change this to tempdir()
  # inputPath = inputDir,
  # outputPath = outputDir
)
 
mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects, paths = paths)

spades(mySim)
```

# Events
Events are scheduled as follows:

- Module initiation
- Model fitting

## Saving
TODO: Write what is saved. (there is currently nothing saved, but this may change in the future)

# Data dependencies

## Input data
- **dataFireSense_SizeFit**: one or more data.frames in which to look for variables present in the model formula.

## Output data
- **fireSense_SizeFitted**: an object of class `fireSense_SizeFit`, i.e. a list containing the following elements:

    - formula (model formula)
    - link (model link)
    - coef (fitted coefficients)
    - se (standard errors)

# Links to other modules
This module could be used in association with the fireSense_SizePredict module.

